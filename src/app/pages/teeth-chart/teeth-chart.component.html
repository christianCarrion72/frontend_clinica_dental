<div [attr.id]="captureId" class="odontogram-layout">
  <section class="odontogram-main">
    <div class="teeth-chart">
      <div class="teeth-row upper-front">
        <div class="tooth" *ngFor="let n of upperTeeth" [attr.data-tooth]="n" [attr.data-view]="'front'" (click)="onToothClick(n)" [style.transform]="offsetTransform(n, 'front')">
          <img *ngIf="getImageSrc(n,'front')"
               (click)="onToothClick(n); $event.stopPropagation()"
               [src]="getImageSrc(n,'front')"
               [attr.data-origin]="getOrigin(n,'front')"
               [alt]="'Tooth '+n"
               [width]="svgWidth('front')"
               [height]="svgHeight('front')" />
          <!-- Tinta recortada por silueta usando CSS mask para igualar exportación -->
          <div *ngIf="shouldTint(n)" class="overlay overlay-tint"
               [style.background-color]="tintFill(n)"
               [style.webkitMaskImage]="'url('+getImageSrc(n,'front')+')'"
               [style.maskImage]="'url('+getImageSrc(n,'front')+')'"
               [style.webkitMaskSize]="'100% 100%'"
               [style.maskSize]="'100% 100%'"
               [style.webkitMaskRepeat]="'no-repeat'"
               [style.maskRepeat]="'no-repeat'"
               [style.webkitMaskPosition]="'0 0'"
               [style.maskPosition]="'0 0'"
               [style.width.px]="svgWidth('front')"
               [style.height.px]="svgHeight('front')"
          ></div>
          <!-- Overlay de shapes con color -->
          <svg *ngIf="patientChart?.teeth?.[n]?.shapes?.front" [attr.width]="svgWidth('front')" [attr.height]="svgHeight('front')" class="overlay overlay-path" (click)="onToothClick(n); $event.stopPropagation()">
            <path [attr.d]="patientChart?.teeth?.[n]?.shapes?.front" [attr.fill]="pathFill(n)" [attr.stroke]="pathStroke(n)" stroke-width="2" (click)="onToothClick(n); $event.stopPropagation()" />
          </svg>
        </div>
      </div>
    
      <div class="teeth-row upper-top">
        <div class="tooth" *ngFor="let n of upperTeeth" [attr.data-tooth]="n" [attr.data-view]="'top'" (click)="onToothClick(n)" [style.transform]="offsetTransform(n, 'top')">
          <img *ngIf="getImageSrc(n,'top')"
               (click)="onToothClick(n); $event.stopPropagation()"
               [src]="getImageSrc(n,'top')"
               [attr.data-origin]="getOrigin(n,'top')"
               [alt]="'Tooth '+n"
               [width]="svgWidth('top')"
               [height]="svgHeight('top')" />
          <div *ngIf="shouldTint(n)" class="overlay overlay-tint"
               [style.background-color]="tintFill(n)"
               [style.webkitMaskImage]="'url('+getImageSrc(n,'top')+')'"
               [style.maskImage]="'url('+getImageSrc(n,'top')+')'"
               [style.webkitMaskSize]="'100% 100%'"
               [style.maskSize]="'100% 100%'"
               [style.webkitMaskRepeat]="'no-repeat'"
               [style.maskRepeat]="'no-repeat'"
               [style.webkitMaskPosition]="'0 0'"
               [style.maskPosition]="'0 0'"
               [style.width.px]="svgWidth('top')"
               [style.height.px]="svgHeight('top')"
          ></div>
          <svg *ngIf="patientChart?.teeth?.[n]?.shapes?.top" [attr.width]="svgWidth('top')" [attr.height]="svgHeight('top')" class="overlay overlay-path" (click)="onToothClick(n); $event.stopPropagation()">
            <path [attr.d]="patientChart?.teeth?.[n]?.shapes?.top" [attr.fill]="pathFill(n)" [attr.stroke]="pathStroke(n)" stroke-width="2" (click)="onToothClick(n); $event.stopPropagation()" />
          </svg>
        </div>
      </div>
    
      <div class="teeth-row lower-top">
        <div class="tooth" *ngFor="let n of lowerTeeth" [attr.data-tooth]="n" [attr.data-view]="'top'" (click)="onToothClick(n)" [style.transform]="offsetTransform(n, 'top')">
          <img *ngIf="getImageSrc(n,'top')" (click)="onToothClick(n); $event.stopPropagation()" [src]="getImageSrc(n,'top')" [attr.data-origin]="getOrigin(n,'top')" [alt]="'Tooth '+n" [width]="svgWidth('top')" [height]="svgHeight('top')" />
          <div *ngIf="shouldTint(n)" class="overlay overlay-tint"
               [style.background-color]="tintFill(n)"
               [style.webkitMaskImage]="'url('+getImageSrc(n,'top')+')'"
               [style.maskImage]="'url('+getImageSrc(n,'top')+')'"
               [style.webkitMaskSize]="'100% 100%'"
               [style.maskSize]="'100% 100%'"
               [style.webkitMaskRepeat]="'no-repeat'"
               [style.maskRepeat]="'no-repeat'"
               [style.webkitMaskPosition]="'0 0'"
               [style.maskPosition]="'0 0'"
               [style.width.px]="svgWidth('top')"
               [style.height.px]="svgHeight('top')"
          ></div>
          <svg *ngIf="patientChart?.teeth?.[n]?.shapes?.top" [attr.width]="svgWidth('top')" [attr.height]="svgHeight('top')" class="overlay overlay-path" (click)="onToothClick(n); $event.stopPropagation()">
            <path [attr.d]="patientChart?.teeth?.[n]?.shapes?.top" [attr.fill]="pathFill(n)" [attr.stroke]="pathStroke(n)" stroke-width="2" (click)="onToothClick(n); $event.stopPropagation()" />
          </svg>
        </div>
      </div>
    
      <div class="teeth-row lower-front">
        <div class="tooth" *ngFor="let n of lowerTeeth" [attr.data-tooth]="n" [attr.data-view]="'front'" (click)="onToothClick(n)" [style.transform]="offsetTransform(n, 'front')">
          <img *ngIf="getImageSrc(n,'front')" (click)="onToothClick(n); $event.stopPropagation()" [src]="getImageSrc(n,'front')" [attr.data-origin]="getOrigin(n,'front')" [alt]="'Tooth '+n" [width]="svgWidth('front')" [height]="svgHeight('front')" />
          <div *ngIf="shouldTint(n)" class="overlay overlay-tint"
               [style.background-color]="tintFill(n)"
               [style.webkitMaskImage]="'url('+getImageSrc(n,'front')+')'"
               [style.maskImage]="'url('+getImageSrc(n,'front')+')'"
               [style.webkitMaskSize]="'100% 100%'"
               [style.maskSize]="'100% 100%'"
               [style.webkitMaskRepeat]="'no-repeat'"
               [style.maskRepeat]="'no-repeat'"
               [style.webkitMaskPosition]="'0 0'"
               [style.maskPosition]="'0 0'"
               [style.width.px]="svgWidth('front')"
               [style.height.px]="svgHeight('front')"
          ></div>
          <svg *ngIf="patientChart?.teeth?.[n]?.shapes?.front" [attr.width]="svgWidth('front')" [attr.height]="svgHeight('front')" class="overlay overlay-path" (click)="onToothClick(n); $event.stopPropagation()">
            <path [attr.d]="patientChart?.teeth?.[n]?.shapes?.front" [attr.fill]="pathFill(n)" [attr.stroke]="pathStroke(n)" stroke-width="2" (click)="onToothClick(n); $event.stopPropagation()" />
          </svg>
        </div>
      </div>
    
      <app-tooth-editor
        *ngIf="editingTooth !== null"
        [patientChart]="patientChart!"
        [toothNumber]="editingTooth!"
        (saved)="onSaved($event)"
        (close)="closeEditor()">
      </app-tooth-editor>
    <!-- Aquí permanece todo tu contenido del odontograma:
           upper-front, upper-top, lower-top, lower-front y <app-tooth-editor> -->
    </div>
  </section>

  <aside class="legend-panel">
    <div class="legend-title">Leyenda</div>
    <div class="legend-list">
      <div class="legend-item" *ngFor="let item of legendItems">
        <span class="color-swatch"
              [style.background-color]="item.ring ? 'transparent' : item.color"
              [style.border-color]="item.color"
              [class.swatch-ring]="item.ring"></span>
        <span class="legend-label">{{ item.label }}</span>
      </div>
    </div>
  <div class="legend-actions">
    <button class="btn btn-primary" (click)="exportImageCanvas()">Exportar</button>
    </div>
  </aside>
</div>
